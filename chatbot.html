<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat – Baromètre de satisfaction</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light only" />
  <link rel="icon" type="image/png" href="https://github.com/olivoliv69/SmartVerbAtIm/blob/main/ia2.png?raw=true" />
</head>
<body class="bg-gray-100 min-h-screen">
  <noscript>
    <div class="p-4 bg-red-100 text-red-800">Activez JavaScript pour utiliser le chat.</div>
  </noscript>

  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r p-6">
      <div class="p-6 flex flex-col items-center gap-4 border-b">
        <img src="https://github.com/olivoliv69/SmartVerbAtIm/blob/main/642fb6cb18990ac38128bbec_Logo-couleurs-1024x388.png?raw=true" alt="Logo Enov" width="120" height="auto">
      </div>
      <div class="mt-6 text-xs text-gray-500">Études</div>
      <div class="mt-2 p-4 rounded-xl bg-blue-600 text-white text-sm">
        Étude APEC –<br/>Baromètre de satisfaction
      </div>
    </aside>

    <!-- Zone principale -->
    <main class="flex-1 flex flex-col">
      <header class="h-16 flex items-center justify-between px-4 md:px-8 bg-white border-b">
        <h1 class="text-lg font-semibold text-gray-800">Explorez la voix de vos clients</h1>
        <div class="flex items-center gap-2">
          <button id="reset" type="button" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm border">
            Nouvelle conversation
          </button>
          <button id="logout" type="button" class="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white text-sm">
            Déconnexion
          </button>
        </div>
      </header>

      <section class="flex-1 flex flex-col">
        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto px-4 md:px-10 py-6 space-y-3">
          <div id="empty" class="h-full w-full grid place-items-center text-center text-gray-500">
            <div>
              <p class="font-medium text-gray-600">Laissez-moi vous aider à explorer les verbatims de vos clients !</p>
              <p class="text-sm mt-1">Exemples : “Cite tous les verbatims sur la livraison” · “Fais une synthèse du SAV”</p>
            </div>
          </div>
        </div>

        <!-- Input -->
        <div class="border-t bg-white px-4 md:px-6 py-4">
          <div class="max-w-4xl mx-auto flex items-center gap-2">
            <input id="q" type="text" placeholder="Tapez votre question…" class="flex-1 rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <button id="send" type="button" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50">
              ➤
            </button>
          </div>
          <p id="chat-error" class="max-w-4xl mx-auto mt-2 text-sm text-red-600"></p>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <!-- JS inline : chat Dify + logout -->
  <script>
  (function () {
    const $ = (id) => document.getElementById(id);

    document.addEventListener("DOMContentLoaded", () => {
      // ---------- Firebase (garde d'accès + logout) ----------
      const firebaseConfig = {
        apiKey: "AIzaSyDP6Wix-qehAnUq9FYmMAYdbEiqKYQnXWs",
        authDomain: "smartverbatims.firebaseapp.com",
        projectId: "smartverbatims",
        storageBucket: "smartverbatims.appspot.com",
        messagingSenderId: "1043743921058",
        appId: "1:1043743921058:web:637f9bc10cc3859e86d8fb",
        measurementId: "G-R64GD8CJLS"
      };
      try {
        if (window.firebase && !firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          const auth = firebase.auth();
          auth.onAuthStateChanged((user) => { if (!user) window.location.href = "index.html"; });
          const logoutBtn = $("logout");
          if (logoutBtn) logoutBtn.addEventListener("click", async () => {
            try { await auth.signOut(); window.location.href = "index.html"; }
            catch (err) { console.error("Déconnexion Firebase:", err); }
          });
        }
      } catch (e) { console.warn("[firebase] init warn:", e); }

      // ---------- UI ----------
      const messages = $("messages"), empty = $("empty"), input = $("q"),
            btn = $("send"), errLine = $("chat-error"), resetBtn = $("reset");
      if (!messages || !input || !btn) {
        if (errLine) errLine.textContent = "Erreur d’init du chat (éléments introuvables).";
        return;
      }
      const refreshBtn = () => btn.disabled = !input.value.trim();
      input.addEventListener("input", refreshBtn); refreshBtn();

      function bubble(text, role) {
        if (empty) empty.remove();
        const line = document.createElement("div");
        // même alignement qu’avant, + avatars (items-start + gap-2)
        line.className = "flex " + (role === "user" ? "justify-end" : "justify-start") + " items-start gap-2";
        // avatar
        const avatar = document.createElement("img");
        avatar.src = (role === "user")
          ? "https://github.com/olivoliv69/SmartVerbAtIm/blob/main/pers.png?raw=true"
          : "https://github.com/olivoliv69/SmartVerbAtIm/blob/main/ia2.png?raw=true";
        avatar.alt = (role === "user") ? "Vous" : "Assistant";
        avatar.width = 32; avatar.height = 32;
        avatar.className = "w-8 h-8 rounded-full border bg-white flex-shrink-0";
        avatar.referrerPolicy = "no-referrer"; // <-- pour éviter certains blocages GitHub
        avatar.loading = "lazy";
        avatar.onerror = () => { avatar.remove(); }; // fallback discret si l’image ne charge pas
        // bulle
        const b = document.createElement("div");
        b.className = (role === "user")
          ? "max-w-[70%] rounded-xl px-4 py-3 bg-blue-600 text-white"
          : "max-w-[70%] rounded-xl px-4 py-3 bg-white border shadow-sm text-gray-800";
        b.textContent = text;
        // ordre : user (bulle puis avatar à droite) / bot (avatar puis bulle à gauche)
        if (role === "user") { line.appendChild(b); line.appendChild(avatar); }
        else { line.appendChild(avatar); line.appendChild(b); }
        messages.appendChild(line);
        messages.scrollTop = messages.scrollHeight;
        return b;
      }

      // ---------- Dify ----------
      const TOKEN = "app-TzgNBWukBZCRAi4wQc2OcS3I";
      const ENDPOINT = "https://dify.enov.fr/v1/chat-messages";
      const FIXED_ETUDE = "DSE0045"; // <- valeur *exacte* exigée par Dify (select)

      let sending = false;
      let conversationId = null;

      if (resetBtn) resetBtn.addEventListener("click", () => {
        conversationId = null;
        messages.innerHTML = "";
        const placeholder = document.createElement("div");
        placeholder.id = "empty";
        placeholder.className = "h-full w-full grid place-items-center text-center text-gray-500";
        placeholder.innerHTML = '<div><p class="font-medium text-gray-600">Nouvelle conversation démarrée.</p></div>';
        messages.appendChild(placeholder);
      });

      async function send() {
        if (sending) return;
        const text = input.value.trim();
        if (!text) return;

        sending = true; btn.disabled = true; if (errLine) errLine.textContent = "";
        bubble(text, "user"); input.value = ""; input.focus(); refreshBtn();
        const bot = bubble("…", "bot");

        // Infos Firebase (optionnelles)
        let fbUser = null;
        try { fbUser = (window.firebase && firebase.auth().currentUser) || null; } catch {}
        const user_id = (fbUser && fbUser.uid) || "web-1";

        // ---- PAYLOAD : etude = "DSE0045" (STRING), rien d’autre d’obligatoire ----
        const payload = {
          inputs: { etude: FIXED_ETUDE },
          response_mode: "blocking",
          auto_generate_name: true,
          query: text,
          user: user_id,
          ...(conversationId ? { conversation_id: conversationId } : {})
        };

        console.log("[chat] typeof etude =", typeof payload.inputs.etude, payload);

        try {
          const res = await fetch(ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: {
              Authorization: "Bearer " + TOKEN,
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify(payload)
          });

          const raw = await res.text(); let data = null;
          try { data = JSON.parse(raw); } catch {}

          if (!res.ok) {
            const detail = (data && (data.message || data.error)) || raw || (res.status + " " + res.statusText);
            bot.textContent = `Erreur ${res.status} : ${detail}`;
            return;
          }

          conversationId = data?.conversation_id || conversationId;
          const answer = data?.answer || (data ? JSON.stringify(data) : "(réponse vide)");
          bot.textContent = answer;
          messages.scrollTop = messages.scrollHeight;
        } catch (e) {
          bot.textContent = "Erreur : " + (e?.message || "réseau.");
          if (errLine) errLine.textContent = "Impossible d’envoyer le message (réseau/CORS ?).";
        } finally {
          sending = false; refreshBtn();
        }
      }

      btn.addEventListener("click", send);
      input.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });
    });
  })();
  </script>
</body>
</html>
